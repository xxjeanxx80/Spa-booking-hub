<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Đăng nhập - BeautyHub</title>
  <link rel="stylesheet" href="css/login.css">
</head>
<body>
  <div class="login-box">
    <h2>Đăng nhập</h2>
    <div id="msg" class="alert"></div>
    <div id="info" class="alert info" style="display:none"></div>
    <form id="loginForm">
      <div class="form-group">
        <label>Email</label>
        <input id="email" type="email" required placeholder="vd: owner@demo.test">
      </div>
      <div class="form-group">
        <label>Mật khẩu</label>
        <input id="password" type="password" required placeholder="••••••">
      </div>
      <div class="form-group form-inline">
        <label class="toggle">
          <input id="togglePassword" type="checkbox">
          Hiển thị mật khẩu
        </label>
        <a href="index.html#spas" class="link">Xem spa nổi bật</a>
      </div>
      <div class="form-group">
        <label>Bạn là (tuỳ chọn)</label>
        <select id="role">
          <option value="">— Không chọn —</option>
          <option value="customer">Khách hàng</option>
          <option value="owner">Chủ spa</option>
          <option value="admin">Admin</option>
        </select>
        <p id="roleHelper" class="hint secondary" style="display:none"></p>
      </div>
      <button type="submit" class="btn">Đăng nhập</button>
      <div class="hint">Demo: owner@demo.test / owner • admin@demo.test / admin • alice@demo.test / 123456</div>
      <p id="recentLogin" class="hint secondary" style="display:none"></p>
    </form>
  </div>

  <script type="module">
    import { login, redirectByRole } from './js/auth.js';
    const LAST_LOGIN_KEY = 'beautyhub:last-login-email';
    const LAST_ROLE_KEY = 'beautyhub:last-login-role';
    const LAST_LOGIN_AT_KEY = 'beautyhub:last-login-at';

    const demoCredentials = {
      owner: { email: 'owner@demo.test', password: 'owner' },
      admin: { email: 'admin@demo.test', password: 'admin' },
      customer: { email: 'alice@demo.test', password: '123456' }
    };

    const roleLabels = {
      owner: 'Chủ spa',
      admin: 'Admin',
      customer: 'Khách hàng'
    };

    const form = document.getElementById('loginForm');
    const msg  = document.getElementById('msg');
    const info = document.getElementById('info');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const roleSelect = document.getElementById('role');
    const togglePassword = document.getElementById('togglePassword');
    const roleHelper = document.getElementById('roleHelper');
    const recentLogin = document.getElementById('recentLogin');

    function showErr(text){
      msg.textContent = text;
      msg.style.display = 'block';
    }

    function hideErr(){
      msg.style.display = 'none';
    }

    const params = new URLSearchParams(window.location.search);
    const requestedRole = params.get('role');
    const signupMode = params.get('mode');
    const queryEmail = params.get('email');
    const storedEmail = localStorage.getItem(LAST_LOGIN_KEY) || '';
    const storedRole = localStorage.getItem(LAST_ROLE_KEY) || '';
    const lastLoginAt = localStorage.getItem(LAST_LOGIN_AT_KEY) || '';
    const prefillEmail = queryEmail || storedEmail;

    const roleByEmail = {};
    Object.keys(demoCredentials).forEach((role) => {
      roleByEmail[demoCredentials[role].email] = role;
    });

    if (prefillEmail) {
      emailInput.value = prefillEmail;
    }

    if (signupMode === 'signup' && info) {
      info.textContent = 'Tài khoản demo sẽ được cấp ngay sau khi bạn hoàn tất bước đăng ký trên trang chủ.';
      info.style.display = 'block';
    }

    if (recentLogin && storedEmail) {
      let message = 'Lần đăng nhập gần nhất: ' + storedEmail;
      if (lastLoginAt) {
        const date = new Date(lastLoginAt);
        if (!Number.isNaN(date.getTime())) {
          try {
            message += ' (' + new Intl.DateTimeFormat('vi-VN', { dateStyle: 'short', timeStyle: 'short' }).format(date) + ')';
          } catch (error) {
            message += ' (' + date.toLocaleString('vi-VN') + ')';
          }
        }
      }
      recentLogin.textContent = message;
      recentLogin.style.display = 'block';
    }

    function applyCredentialsForRole(role, options) {
      if (!role) {
        passwordInput.placeholder = '••••••';
        return;
      }
      const creds = demoCredentials[role];
      if (!creds) {
        passwordInput.placeholder = '••••••';
        return;
      }
      const forceFill = options && options.forceFill;
      if (forceFill || !emailInput.value) {
        emailInput.value = creds.email;
      }
      if (forceFill || !passwordInput.value) {
        passwordInput.value = creds.password;
      }
      passwordInput.placeholder = 'Ví dụ: ' + creds.password;
    }

    function updateRoleHelper(role) {
      if (!roleHelper) {
        return;
      }
      if (!role) {
        roleHelper.style.display = 'block';
        if (storedRole && roleLabels[storedRole]) {
          roleHelper.textContent = 'Gợi ý: Lần trước bạn đăng nhập với vai trò ' + roleLabels[storedRole] + '.';
        } else {
          roleHelper.textContent = 'Chọn vai trò để hệ thống gợi ý tài khoản demo phù hợp.';
        }
        return;
      }
      const creds = demoCredentials[role];
      if (creds) {
        roleHelper.style.display = 'block';
        roleHelper.textContent = roleLabels[role] + ' demo: ' + creds.email + ' / ' + creds.password;
      } else {
        roleHelper.style.display = 'none';
      }
    }

    function setRole(role, options) {
      if (!role) {
        updateRoleHelper('');
        return;
      }
      const option = roleSelect.querySelector('option[value="' + role + '"]');
      if (!option) {
        updateRoleHelper('');
        return;
      }
      roleSelect.value = role;
      applyCredentialsForRole(role, options);
      updateRoleHelper(role);
    }

    if (requestedRole) {
      setRole(requestedRole, { forceFill: !queryEmail });
    } else if (storedRole) {
      setRole(storedRole, { forceFill: false });
    } else {
      updateRoleHelper('');
    }

    if (togglePassword) {
      togglePassword.addEventListener('change', (event) => {
        passwordInput.type = event.target.checked ? 'text' : 'password';
      });
    }

    roleSelect.addEventListener('change', () => {
      const role = roleSelect.value.trim();
      if (role) {
        setRole(role, { forceFill: true });
      } else {
        passwordInput.placeholder = '••••••';
        updateRoleHelper('');
      }
    });

    emailInput.addEventListener('blur', () => {
      const email = emailInput.value.trim().toLowerCase();
      const matchedRole = roleByEmail[email];
      if (matchedRole) {
        setRole(matchedRole, { forceFill: false });
      }
    });

    form.addEventListener('submit', (event)=>{
      event.preventDefault();
      hideErr();

      const email = emailInput.value.trim();
      const pass  = passwordInput.value;
      const role  = roleSelect.value.trim();

      try{
        const sess = login(email, pass, role);
        localStorage.setItem(LAST_LOGIN_KEY, email);
        localStorage.setItem(LAST_ROLE_KEY, sess.role);
        localStorage.setItem(LAST_LOGIN_AT_KEY, new Date().toISOString());
        redirectByRole(sess.role);
      }catch(err){
        showErr(err.message || 'Đăng nhập thất bại');
      }
    });
  </script>
</body>
</html>
